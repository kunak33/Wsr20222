Маски и то се 
Интерфейсы через network manager
Файл на плату накладывается с его конфигом
Профили настроивать
Nmcli
nmtui
Найти мак ip add - просмотреть ip и мак 
Eth физ машина
Смотрим мак адреса

-Днс сервер и настройки основных служб
/etc/resolv.conf
В стартап добавить службы 
Шлюз на енс 33 10.10.10.10
route print
Шлюзы клиенты, сервы по бокам
Дшсп реле связь между роутерами не будет пока не будет маршрутизации
Сеть провайдера мешает оспф
Гре туннель

Порты через статик нат 

#firewalld 

-Отключим фаервол(по приколу ) и системы  защиты линукс
systemctl disable firewalld
systemctl stop firewalld

systemctl status service 

-Selinux:
#Vi /etc/selinux/config
i  
(Enforcing) Enebled -->diseble
Esc
 :wq
#setenforce 0
#reboot
_------------------------------------------

-Сетевые карты
Мак чекаем - Ip add
/Лучше пометить на сехме/

vi /etc/selinux
systemctl stop firwalld
Systemxtl diseble firewalld

Setenforce 0
Reboot
---------
-Nmtui

Название то се 
В ip через префикс маску
Enc192
Гетвей 10.10.10.10

!Автоматикли коннект поставь галочку

Enc34
172.16.50.1/30
!Автоматикли коннект галочка

Enc33
172.16.20.1/24
!автоматикли коннект галка

Enc35
172.16.55.1/30


Перезагрузить профили
Переименовать машину

-----_________________
---L-srv
Отключаем фаервол и селинукс
Nmtui настраиваем дефолты
Галочка
setenforce 0

Vi /etc/nsswitch
Hosts dns  files разкомментить


L-rw #forwardinf 
Ip ro табл маршрутизации
Cat /proc/sys/net/ipv4/ip_forward
0
Vi /etc/sysctl.d/99-sysctl.conf

 net.Ipv4.ip_forward =1- что мы машина работала как роутер после ребута
 Reboot


Установка пачетов #yum 
 Cat /etc/yum

Прокси 
Vi etc/yum.conf
 Proxy-http://10.10.10.10:3128

Nat l fw #nat 
Iptables -L -v -n (тип фаервола )
Iptables -t nat -L

touch /etc/nat.sh со то здать файл
chmod +x /etc/nat.sh  сделать исполняемым
Chmod +x /etc/rc.local
Ls -la /etc/nat.sh

Vi /etc/rc.local
  /Etc/nat.sh

Файл 
Iptables -t nat -A POSTROUTING -o ens192 -j MASQUERADE (маскарад)
iptables -t nat -L



L srv
Proxy=http://10.10.10.10:3128
Dns
Yum install bind днс соужба

systemctl status named
 *named


Маршрутизатор
Шлюз что бы пачеты скачать
Frr служба маршрутизации
Включи 

#ospf 
23.221
Vi /etc/frr/daemons

3 демона которые нужно врубить в конфиге
vtysh
Zebra 
Ospfd

 Reatart frrи 
int tun1 
Ospf network point to point
Tcpdump -i tun1 слушать 




Dhcp 

#dhcp

mc мц коммандер файловый менеджер миднайт 

/etc/dhcp/dhcpd.conf
A slighty sifferebt configuration

фиксированный
00:0C:29:83:EF:20
Осторожной в конфиге
00:0C:29:F9:AC:7F


Dhcp relay

Запустить службу создаться кофиг
Config изменить строчку экзека 3 строчки 
Перезапустить службу 
Перезапкстить демонов 
Перезапкстить службу



Службы


-------------------
Не мое украл у Игоря с того года, ко мне 0 вопросов.
Настройка через Network Manager
Через утилиту nmtui мы будем производить настройку профилей и сетевых карт (IP, MASK, DNS) 
Для того чтобы узнать MAC есть команда ip add, которая позволяет посмотреть IP и MAC, которые установлены на сетевой карте
DNS и основные параметры сетевых служб находятся в каталоге /etc/resolv.conf
 ! Очень важно сохранять и добавлять в автозапуск все произведенные настройки
 L-RTR-A - DHCP сервер, а L-RTR-B - DHCP реле

Systemctl disable firewalld (вообще убрать с автозагрузки) 
Systemctl stop firewalld (остановить в текущий момент) 
Systemctl status /SERVICE/
_________________________
 Selinux:
 #vi /etc/selinux/config 
 i
 enforsing->disabled
 ESCAPE
 :wq
 #setenforce 0
 #reboot
 _________________________
ISPnorm ОБЯЗАТЕЛЬНО запустить с "I MOVED IT", остальные запускать с "i copied it"
ISP обычный НЕ ТРОГАЕМ

         root
         toor

ip add
Лучше пометить на схеме
После этого отключим фаервол и отключим селинукс
vi /etc/selinux
ctrl+c - прервать
systemctl stop firewalld
systemctl disable firewalld

setenforce 0 - для того чтобы параметры селинукса применились
 
После этого настраиваем интерфейсы через nmtui
Перейдем в edit a connection
Заходим в профиль и вижим MAC адрес сетевой карты, название профиля
Выберем параметр IPv4 не автоматический, а статический (manual)
Заходим в меню show и вводим IP адрес, обязательно через префикс маску (например, для Ens192 - 10.10.10.1/24)
Выставляем шлюз (например, 10.10.10.10)
ОБЯЗАТЕЛЬНО поставить галочку automatic reconnect (сделать это можно нажав пробел)
Применим настройки, нажмем ok
Перезагружаем все карты в другом пункте меню
Меняем имя машины
Ens192
10.10.10.1/24
Шлюз 10.10.10.10
!автоматик коннект галочка

Ens34
172.16.50.1/30
Шлюз не указываем
!автоматик коннект галочка

Ens33
172.16.20.1/24
Шлюз не указываем
!автоматик коннект галочка

Ens35
172.16.55.1/30
Шлюз не указываем
!автоматик коннект галочка

Перезагрузить все профили
Переименовать машину

______________________________

Переходим на L-SRV
Сразу отключаем фаервол и селинукс
nmtui настраиваем 
setenforce 0

ip по таблице маршрутизации

vi /etc/sysctl.d/9 + tab (настраивать форвардинг надо на фаерволах и роутерах) 

После него проверяем записалась ли единица в форвард (важно для NAT) 
Проверяем proc/sys/net/ipv4/ip_forward  и смотрим единицу 

Установка пакетов осуществляется через yum install

Как настроить прокси:
 vi /etc/yum.conf
 proxy=http://10.10.10.10:3128
 reboot

yum install frr 
(служба маршрутизации) 

NAT на LFW
iptables -L -v -n (что-то типо фаервола)
iptables -t nat -L (таблица)

Создание файлов
touch /etc/nat.sh создать файл
chmod +x /etc/nat.sh сделать исполняемым
ls -la /etc/nat.sh

Vi /etc/rc.local
И в файле rc.local пишем:
 /etc/nat.sh
 Также делаем rclocal исполняемым  
А теперь сделаем его исполняемым 

В файле nat.sh пишем
iptables -t nat -A POSTROUTING -o ens192 -j MASQUERADE (маскарад) 
ens у R-FW будет ДРУГИМ (34)

reboot
Проверим появился ли маскарад в чейне построутинг
iptables -t nat -L 

Дальше на LFW включаем перенаправление трафика, чтобы NAT заработал
Vi /etc/sysctl.d/99-sysctl.conf
И пишем туда
net.ipv4.ip_forward=1
reboot

L-SRV
vi /etc/yum.conf
 proxy=http://10.10.10.10:3128
 reboot
Теперь
yum install bind - служба днс

systemctl status named
*named

Машрутизатор
L-RTR
Отключить фаервол и селинукс
Шлюз для установки пакетов
yum install frr -y - служба маршрутизации
Включить

ip route - команда проверки маршрутов

Зайдем в nat.sh на L-FW и вписываем команды которые я сфотографировал, затем сохраняем и выходим (wq), тоже самое на R-FW только с другими айпи адресами и перезагружаем оба фаервола, после перезагрузки проверяем статус службы frr

Vi /etc/frr/daemons
Вписать vtysh=yes
Включить zebra=yes
Включить ostpfd=yes

systemctl restart frr 
systemctl status frr

Пассивный интерфейс - тот, что идет на клиента, их нужно вписывать роутерам

На L-RTR-A:
vtysh 
Conf t
Router ospf
Network 172.16.100.0/24 area 0.0.0.0
Network 172.16.50.0/30 area 0.0.0.0
Passive-interface ens33
------
Passive-interface на L-RTR-A, L-RTR-B и R-RTR - ens33, (если в nmtui не настроен то настроить) 
------
Exit

Выходим из конфига и обязательно пишем wr

Systemctl restart frr 
Systemctl enable frr

На L-FW:
vtysh 
Conf t
Router ospf
Network 172.16.50.0/30 area 0.0.0.0
Network 172.16.55.0/30 area 0.0.0.0
Network 172.16.20.0/24 area 0.0.0.0
Network 10.5.5.0/30 area 0.0.0.0 (наш гре тунель)  
Exit 

Выходим из конфига и обязательно пишем wr
Systemctl restart frr 
Systemctl enable frr
Ip ro

Systemctl enable frr (ОБЯЗАТЕЛЬНО) 

________________________________

СПОСОБ ЧЕРЕЗ MC (MIDNIGHT COMMANDER):
________________________________

На L-RTR-A
yum install dhcp-server -y
yum install mc -y (midnight commander) 
dhcp добавляем в автозагрузку (Выдаст ошибку но так и надо) 
Заходим в /etc/dhcp/dhcp.conf и в другом окне к usr/share/doc/dhcp-server и копируем оттуда экзампл через F5 прямо в путь /etc/dhcp/dhcp.conf, соглашаемся на overwrite
Далее комментим ВЕСЬ документ и настраиваем три пула, а также L-CLI-B как на фотках

Теперь ОБЯЗАТЕЛЬНО:
systemctl start dhcpd
systemctl restart dhcpd
systemctl enable dhcpd

(если выдало ошибку то переходим в journalctl -xe, смотрим ошибки, затем фиксим их в документе и пишем это все еще раз) 

Теперь заходим на L-CLI-A и проверяем что он получил 65-й айпишник 
 
Теперь переходим на L-RTR-B и ставим dhcp реле (dhcp-relay) и потом ставим mc тоже
dhcp реле тоже добавляем в автозагрузку

_______________________

СПОСОБ ЧЕРЕЗ NANO:
_______________________

(через нано удобнее, потому что видно, где строчка закомменчена) 

Заходим на L-RTR-A 
yum install dhcp-server -y
Далее копируем наш файл 

cp /usr/share/doc/dhcp-server/dhcpd.conf.example /etc/dhcp/dhcpd.conf

На вопрос заменять ли (overwrite) отвечаем ДА

Теперь открываем nano /etc/dhcp/dhcpd.conf
И редактируем как по фоткам

Как скопировать:
Выделяем серез шифт: жмем ctrl+k (оно вырежется) и затем ctrl+u (жмем так три раза) 

-------------------
Как сохранить файл в nano:
Ctrl+o
Enter
Ctrl+x
Clear
-------------------
systemctl restart dhcpd
systemctl enable dhcpd

Если выдает ошибку то переходим в файл который написан в ошибке (там с "-x" и тд) там смотрим в каких строчках ошибки, заходим в файл nano /etc/dhcp/dhcpd.conf и исправляем их, сохраняем и снова пишем systemctl restart dhcpd
systemctl enable dhcpd

Теперь переходим на L-RTR-B 

yum install dhcp-relay

systemctl enable dhcrelay
Теперь переходим в службу которая написана в пути автозагрузки (слева):
nano /etc/systemd/system/multi-user.target.wants/dhcrelay.service

Теперь отредактируем: переходим на строчку ExecStart (остальные строчки не трогаем вообще) 
Удаляем "-d" и после "--no-pid" пишем:
 "-i ens33 -i ens192 -d 172.16.50.2"
 Больше ничего не трогаем и сохраняем так
 (Ctrl+o
 Enter
 Ctrl+x
 Clear) 
 
И обязательно 
 systemctl daemon-reload
 systemctl start dhcrelay
 systemctl restart dhcrelay
 systemctl enable dhcrelay
 systemctl status dhcrelay

В первоначальных настройках на CLI жмем везде next до упора и skip

Заходим на L-CLI-A и проверяем выдался ли айпи:
Открываем справа вверху список где кнопка выключения, wired off>connect, если приконнектилось то все работает, можно также дополнительно проверить через консоль и ip add
Если все правильно, то в "2:" в строке ens192 должен быть inet 172.16.100.65/24
brd 172.16.100.255

Заходим на L-CLI-B и проверяем выдался ли айпи через реле таким же способом:

Открываем справа вверху список где кнопка выключения, wired off>connect, если приконнектилось то все работает, можно также  дополнительно проверить через консоль и ip add
Если все правильно, то в "2:" в строке ens192 должен быть inet 172.16.200.61/24
brd 172.16.200.255

Теперь на каждом компе кроме клиентского пишем nano /etc/nsswitch и в самом конце в "hosts:" меняем files dns на dns files

Проверим чтт на L-SRV и R-SRV установлен bind: systemctl status named 
Должно показать
 Loaded: loaded (обязательно) 
 Active: inactive(dead) 
Также можно проверить что на серверах отключен фаервол и селинукс
  systemctl status firewalld
Должно быть dead
  cat /etc/selinux/config
Должно быть disabled

Пинганем R-SRV с L-SRV
Переходим на L-SRV и пишем 
ping 192.168.20.10


Далее на L-SRV и R-SRV устанавливаем mc

Запускаем на L-SRV mc (просто пишем mc в командную строку) 
Переходим в /etc/named.conf (в самом конце) 
Нажимаем F4 и заходим в этот файл
Listen-on-port Меняем адрес с 127.0.0.1 на 172.16.20.10
Следующую строчку listen-on-v6 порт закомментируем двумя обычными слешами (//) 
Далее файлы и пути не трогаем
А вот в последней строчке allow-query пишем "any;" вместо "localhost;" (должно стать красным
В строчке recursion пишем no вместо yes
А строчку dnssec-enable просто закомментируем (//) 
Перейдем в самый верх и включим опцию форвардера 
Переходим в самый самый низ к файлам зон (две строчки include) 

Primary DNS server это L-SRV с зоной skill39.wsr, а secondary DNS server это R-SRV, на которым мы через L-SRV передадим нашу зону skill39.wsr
На сервере ISP тоже настроен сервер DNS для того чтобы при обращении клиентов к внешнему сайту они смотри его достичь. Чтобы достичь этого, клиенты должны обратиться к DNS серверу L-SRV или R-SRV, а те должны перенаправить запрос на ISP
Клиент OUT-CLI должен иметь возможностт разрешать имя www.skill39.wsr. Так как он находится вне наших зон, нам поможет технология проброса портов
Служба DNS по умолчанию работает на 53 порт
Нужно сделать так чтобы при обращении OUT-CLI на порт 53 фаервола его перенаправляли на L-SRV 
Тут поможет технология перенаправления портов port forward 

Вернемся к настройке
Под allow-query через enter создаем новую строчку и пишем там (дословно до пробелов) 
forwarders { 10.10.10.10; };

Сохраняем наш файл
Жмем escape и выбираем yes
Прямо под нашим файлом в списке появится еще один (named.rfc1912.zones), переходим в него с помощью F4

Выделяем первую зону и копируем ее с помощью F5 и комментируем оригинальную полностью, оставляем только скопированную, тоже самре делаем и с зоной 1.0.0.127. in-addr.arpa 
И комментируем ВСЕ зоны, кроме двух скопированных (скрин если что есть) 
Настраиваем зоны (как на фотках) выходим, и сохраняем

Выходим из каталога и заходим в 
/var/named

И видим там localhost и loopback

Переходим через tab во второе окно т заходим в opt

Создаем новый каталог через F7 и называем его dns 

Копируем локалхост и лупбек и эдитим их как на скринах и сохраняем

Переходим снова в etc/named.rfc1921 и комментим нашу обратную зону (снизу) 

Выходим из mc и пишем systemctl start named и фиксим через вим если надо
(добавляем точку с запятой после форвардинга) 
systemctl restart named
systemctl status named (проверяем что включено) 
systemctl enable named (ОБЯЗАТЕЛЬНО) 

Теперь проверим что все работает, переходим на L-CLI-A и пишем
ping l-srv.skill39.wsr
ping server.skill39.wsr
ping www.skill39.wsr (должно выдать 20.20.20.100)
ping l-cli-a.skill39.wsr
ping l-cli-b.skill39.wsr
ping l-fw.skill39.wsr
Должны идти пинги везде 
Пробуем ввести ping ya.ru
А также ping mirror.yandex.ru
(Но не пингуется, ошибка не наша, а в настройке ISP) 

Проверяем что на L-SRV служба named добавлена в автозагрузку
systemctl enable named

Перейдем на L-SRV в vi /etc/named.conf и заменяем там в рекурсии no на yes и сохраняем, перезапускаем службу named и снова пингуем ya.ru с L-CLI-A, должно выдать 99.99.99.99

Теперь настроим обратную зону, заходим на L-SRV в mc и открываем наш файл
 /opt/dns/reversright.wsr и редачим как на фотке
 Теперь переходим в левой странице экрана в /etc/named.rfc1912.zones и разкомменчиваем там обратно нашу обратную зону, выходим из mc 
 И пишем systemctl restart named (ошибки быть не должно) 
 Пишем journalctl -xe и видим что добавилось две зоны

Переходим на L-CLI-A и пишем 
nslookup 192.168.20.10
Должно выдать 
10.20.168.192.in-addr.arpa
name = r-srv.skill39.wsr

~мысль~
~по приколу настроить nmtui на клиентах~

Перейдем на L-SRV и пишем 
cp /opt/dns/reversright.wsr /opt/dns/reversleft.wsr

vi /opt/dns/reversleft.wsr и настраиваем как на фотке
Теперь перейдем в 
vi /etc/named.rfc1912.zones
И вбиваем ниже вторую зону

Сохраняем и перезапускаем службу named
Переходим на L-CLI-A и пишем 
nslookup 172.16.20.10
Выдаст SERVFAIL

Поэтому переходим на L-SRV и пишем команду chmod 777 /opt/dns/reversleft.wsr
systemctl restart named
Теперь переходим в reverseleft и дебажим адреса как на фото и исправляем r-srv на l-srv, теперь сохраним, затем рестартнем name и добавим в enable
Перейдем в L-CLI-A и проверим nslookup 172.16.20.10 
Должно выдать 
10.20.16.172.in-addr.arpa
 name = l-srv.skill39.wsr (обязательно l-srv) 

L-SRV
nano /etc/rsyslog.conf
Разкомментируем две строки, module и input
Которые рядом друг с другом с портом 514

mkdir /opt/logs
mkdir /opt/logs/L-SRV
Теперь заходим в файл и пишем в конце куда сохранять логи (на фотке) 

systemctl restart rsyslog.service

СЕРВЕРА тоже в пассивные интерфейсы нужно как и клиентов
На L-CLI-A и L-CLI-B галочки автоматикли коннект в nmtui и automatic адрес оставить


+0.50 БАЛЛА ЗА yum update -y на L-SRV (чекнуть в задании точно где) 
